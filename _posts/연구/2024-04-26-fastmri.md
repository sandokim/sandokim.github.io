---
title: "[MR 연구] fastMRI & skm-tea"
last_modified_at: 2024-04-26
categories:
  - 연구
tags:
  - 연구
  - MR Reconstruction
  - fastMRI
  - skm-tea
excerpt: "fastMRI & skm-tea"
use_math: true
classes: wide
---

> [[fastMRI Dataset](https://fastmri.med.nyu.edu/)] [[fastMRI Github](https://github.com/facebookresearch/fastMRI?tab=readme-ov-file)] [[skm-tea Dataset](https://stanfordaimi.azurewebsites.net/datasets/4aaeafb9-c6e6-4e3c-9188-3aaaf0e0a9e7)] [[skm-tea Github](https://github.com/StanfordMIMI/skm-tea)]

> fastMRI_knee_unfolded --> keys ['ismrmrd_header', 'kspace', 'reconstruction_rss']
```python
import h5py
file_path = "/mai_nas/GH/fastMRI_knee_unfolded/val/multicoil_val/file1000000.h5"
with h5py.File(file_path, 'r') as h5_file:
  print(h5_file.keys())
  kspace = h5_file['kspace']
  reconstruction_rss = h5_file['reconstruction_rss']
```
kspace shape: (35, 15, 640, 368) --> slices:35, maps:15, H:640, W:368 need to crop to 320, 320

reconstruction_rss shape: (35, 320, 320) --> slices:35, H:320, W:320


> skm-tea --> keys ['kspace', 'maps', 'masks', 'target']
```python
import h5py
file_path = "/mai_nas/yj/Data/skm-tea/v1-release/files_recon_calib-24/MTR_001.h5"
with h5py.File(file_path, 'r') as h5_file:
  print(h5_file.keys())
  kspace = h5_file['kspace']
  maps = h5_file['maps']
  target = h5_file['target']
```
kspace shape: (512, 512, 160, 2, 16) # H:512, W:512, D:160, T1 or T2: 2, maps:16

target(=MR image) shape: (512, 512, 160, 2, 1) # H:512, W:512, D:160, T1 or T2: 2, channel:1

maps shape: (512, 512, 160, 16, 1) # H:512, W:512, D:160, maps:16, channel:1


## Real Data path (.h5)
```python
fastMRI_knee_unfolded: /mai_nas/GH/fastMRI_knee_unfolded/val/multicoil_val --> file1000000.h5, ...

skm-tea: /mai_nas/yj/Data/skm-tea/v1-release/files_recon_calib-24--> MTR_001.h5, ...
```

# Real, Simul의 *npy* shape은 다음과 같이 만들어주었음!
#### fastMRI kspace shape: (15, 320, 320) : (# of coilmap, H, W)
#### skm-tea kspace shape: (512, 160, 8) : (H, W, # of coilmap)

## Real Data path (.npy) 

```python
fastMRI_knee_unfolded: /mnt/KHS/Data/fastMRI_knee_unfolded/val2d_10/multicoil_val/real_kspace/file1000000 --> 000.npy, 001.npy, ...

skm-tea: /mnt/KHS/Data/skm-tea/v1-release/val_axial/multicoil_val/real_kspace/MTR_001 --> 000.npy, 001.npy, ...
```

## Simulation Data Path (.npy)
```python
fasMRI_knee_unfolded: /mnt/KHS/Data/fastMRI_knee_unfolded/val2d_10/multicoil_val --> simul_kspace, map, mask : .npy
- simul_kspace_v1 (subject별 3~4개씩 하여 slice 100장 추출)

skm-tea: /mnt/KHS/Data/skm-tea/v1-release/val_axial/multicoil_val --> simul_kspace, map, mask : .npy
- simul_kspace_v1 (subject별 3~4개씩 하여 slice 100장 추출)
```

### fastMRI 320x320 crop 주의할 점 (kspace에서 crop하면 안된다!)
fastMRI는 Real Data h5에서 kspace에서 320x320으로 crop하여 npy로 저장하여 사용하면, high frequency 정보가 날아가고 low resolution이 되버리기 때문에 찌그러진 영상이 나온다.

<p align="center">
  <img src="https://github.com/sandokim/sandokim.github.io/assets/74639652/b08fbd8f-39cf-42af-895e-2a26803c2013" alt="Image">
</p>

따라서 kspace를 crop하지 말고 image domain으로 바꾸고 image domain에서 320x320 center crop을 한 다음, 320x320 crop된 image에 대해 BART로 estimate한 coilmap 정보로 320x320 kspace로 만들어준다. 
(이는 coilmap을 BART로 추정한 것을 사용하여 kspace를 만들어냈으므로 simulation data가 된다.)

### fastMRI Real Data를 사용하려면 kspace를 그대로 사용하고 image domain에서 crop..



